syntax = "proto3";

package ibeam_core;
option go_package = ".;ibeam_core";

service IbeamCore {
  rpc CoreInfo(CoreInfoRequest) returns (CoreInfoData);
  // No id -> get everything
  rpc DeviceInfo(DeviceIds) returns (DeviceInfos);

  //---------------------

  // No id -> get everything, as ParamID has 2 dimensions this rule should work
  // in both
  rpc Get(DeviceParameterIds) returns (Parameters);
  rpc GetParameterDetails(ParameterIds) returns (ParameterDetails);

  rpc Set(Parameters) returns (Parameters);

  // No id -> subscribe to everything
  // On subscribe all current values should be sent back!
  rpc Subscribe(DeviceParameterIds) returns (stream Parameter);
}

message CoreInfoRequest {}

message CoreInfoData {
  int32 ibeamVersion = 1; // Implemented version of the IBeam Protocol
  int32 coreVersion = 2;
  // In unisketch this should be a hard break that requires updating!
  string productName = 3;
  int32 maxDevices = 4;
  int32 connectedClients = 6;
}

message DeviceIds { int32 deviceId = 1; }

message DeviceInfos { repeated DeviceInfo info = 1; }

message DeviceInfo {
  int32 id = 1;
  bool connected = 2;
  string name = 3;
  ConnectionType connectionType = 4;
}

message DeviceParameterIds { repeated DeviceParameterId id = 1; }
message ParameterIds { repeated int32 id = 1; }
message ParameterDetails { repeated ParameterDetail details = 1; }

message DeviceParameterId {
  // Keep in mind that 0 -> absent in protobuf,
  // so DO NOT map params or devices to id 0
  int32 parameter = 1;
  int32 device = 2;
}

message ParameterOption {
  int32 id = 1;
  string name = 2;
}

message Parameters { repeated Parameter parameters = 1; }
message Parameter {
  DeviceParameterId id = 1;
  ParameterValue value = 2;
  repeated ParamaterArgument arguments = 3;
}

message ParamaterArgument {
  oneof value {
    int32 number = 3;
    float floating = 4;
    ParameterOption options = 5;
    int32 currentOption = 6;
  }
};

message ParameterValue {
  int32 parameterId = 1;
  bool isAssumedState = 2;
  oneof value {
    int32 int = 3;
    float floating = 4;
    string str = 5;
    int32 currentOption = 6;
  }
}

message ParameterDetail {
  int32 id = 1;
  string name = 2;
  repeated ArgumentDetail argumentDetail = 3;
  GenericType genericType = 4;
  ControlStyle controlStyle = 5;
  FeedbackStyle feedbackStyle = 6;
  string label = 7;
  string shortLabel = 8;
  string description = 9; // Not sure we need this
}

message ArgumentDetail {
  int32 id = 1;
  ArgumentType argType = 2;
  int32 minimum = 3; // optional, proto3 makes all values optional
  int32 maximum = 4; // optional
  repeated ParameterOption optionList = 5; // optional
}

enum ControlStyle {
  UndefinedControl = 0;
  FullControl = 1;
  Up_down = 2;
  NoControl = 3;
  Oneshot = 4;
}

enum FeedbackStyle {
  UndefinedFeedback = 0;
  FullFeedback = 1;
  Delayed = 2;
  NoFeedback = 3;
}

enum GenericType {
  Generic = 0;
  DeviceIP = 1;
  Pan = 2;
  Tilt = 3;
  Tally = 4;
  Record = 5;
  Iris = 6;
}

enum ArgumentType {
  Undefined = 0;
  Number = 1;
  Floating = 2;
  Opt = 3;
  String = 4;
}

enum ConnectionType {
  Other = 0;
  Network = 1;
  Serial = 2;
  Sdi = 3;
}

// Current TODO
/*
- [ ] Parameters need some way of signaling RETVAL_Format style rendering info,
some of which could also be default behaviour
- [ ] The device abstraction feels odd currently... we should improve that
- [ ] The concept of parameter arguments needs some decent reevaluation!
- [ ] What about speed values ?
*/
